#!/usr/bin/env node

var path = require("path");
var parseArgs = require("minimist");
var pipeline = require("../lib/pipeline");

var args = parseArgs(process.argv.slice(2), {
    "boolean": ["verbose", "clean", "continue"],
    "string": ["filter", "manifestFormat"],
    "alias": {
        "verbose" : "v",
        "clean": "c",
        "filter": "f",
        "manifestFormat": "m",
        "continue": ["i", "ignore"]
    }
});

var cwd = process.cwd();
var sourceDir = cwd;

if (args._.length >= 1) {
    sourceDir = path.resolve(cwd, args._[0]);
}

var targetDir = sourceDir;

if (args._.length >= 2) {
    targetDir = path.resolve(cwd, args._[1]);
}

var options = {
    logger: args.verbose ? console.log : null,
    filter: args.filter || null,
    manifestFormat: args.manifestFormat,
    continueOnError: args["continue"] || false
};

var exitCode = 0;

if (args.c || args.clean || false) {
    exitCode = pipeline.clean(sourceDir, options);
} else {
    exitCode = pipeline.processDirectory(sourceDir, targetDir, options);
}

process.exit(exitCode);